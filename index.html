<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <title>Quake Web Tools</title>
    <link rel="stylesheet" href="css/style.css">

    <!--lib-->
    <script src="scripts/lib/DataStream.js"></script>
    <!--util-->
    <script src="scripts/util/filemanager.js"></script>
    <script src="scripts/util/fileutil.js"></script>
    <script src="scripts/util/imageutil.js"></script>
    <!--types-->
    <script src="scripts/types/pak.js"></script>
    <script src="scripts/types/wad.js"></script>
    <script src="scripts/types/pal.js"></script>
    <script src="scripts/types/lmp.js"></script>
    <script src="scripts/types/spr.js"></script>
    <script src="scripts/types/bsp.js"></script>
    <!--application-->
    <script src="scripts/quakewebtools.js"></script>
  </head>

  <body onload="app_init()">

    <article>
      <div id="holder" class="filedrop" style="width: 600px; height: 100px">
        <p>DROP FILES HERE</p>
      </div> 
      <p id="status">File API and FileReader API not supported</p>
      <p>Drag Quake file format files (pak, wad, bsp, lmp, spr, mdl, map,
      pal) into the area above to load their content in your browser.</p>
    </article>

    <div id="file-content" style="width: 600px; border:0">
    </div>

  </body>
</html>



<!-- TODO: Clean up this mess and put it in a better location -->
<script>

var holder = document.getElementById('holder');
var state = document.getElementById('status');

if (typeof window.FileReader === 'undefined') {
  state.className = 'fail';
} else {
  state.parentNode.removeChild(state);
}
 
holder.ondragover = function () { this.className = 'filedrop-hover'; return false; };
holder.ondragleave = function () { this.className = 'filedrop'; return false; };
holder.ondragend = holder.ondragleave;
holder.ondrop = function (e) {
  this.className = 'filedrop';
  e.preventDefault();

  var file = e.dataTransfer.files[0];
  var reader = new FileReader();
  reader.onload = function (event) {
    var QWT = QuakeWebTools;
    var G = QWT.GLOBAL;

    var file_entry = G.FILEMANAGER.addFile(file.name, event.target.result);
    var filename = file_entry.path;
    var arraybuffer = file_entry.data;

    document.getElementById("file-content").innerHTML = "";
    
    switch (file_entry.type) {
    case "pak":
      loadPAK(filename, arraybuffer);
      break;
    case "wad":
      var wad = file_entry.obj;//new QWT.WAD(filename, arraybuffer);
      QWT.ImageUtil.generateHTMLPreview(wad.directory, wad.ab, QWT.DEFAULT_PALETTE, "file-content");    
      break;
    case "bsp":
      var bsp = file_entry.obj;//new QWT.BSP(filename, arraybuffer);
      QWT.ImageUtil.generateHTMLPreview(bsp.miptex_directory, bsp.ab, QWT.DEFAULT_PALETTE, "file-content");
      break;
    case "spr":
      var spr = file_entry.obj;//new QWT.SPR(filename, arraybuffer);
      break;
    case "lmp":
      var image_data = QWT.ImageUtil.getImageData(filename, arraybuffer);
      var img = QWT.ImageUtil.expandImageData(image_data, QWT.DEFAULT_PALETTE);
      document.getElementById("file-content").appendChild(img);
      break;
    case "pal":
      var image_data = QWT.ImageUtil.getImageData(filename, arraybuffer);
      var img = QWT.ImageUtil.expandImageData(image_data);
      document.getElementById("file-content").appendChild(img);
      break;
    default:
      var msg = "File type not supported (" + file_entry.type + ")";
      alert(msg);
    }
  };

  reader.readAsArrayBuffer(file);

  return false;
};

</script>